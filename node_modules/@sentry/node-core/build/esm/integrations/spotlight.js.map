{"version":3,"file":"spotlight.js","sources":["../../../src/integrations/spotlight.ts"],"sourcesContent":["import * as http from 'node:http';\nimport type { Client, Envelope, IntegrationFn } from '@sentry/core';\nimport { debug, defineIntegration, serializeEnvelope, suppressTracing } from '@sentry/core';\n\ntype SpotlightConnectionOptions = {\n  /**\n   * Set this if the Spotlight Sidecar is not running on localhost:8969\n   * By default, the Url is set to http://localhost:8969/stream\n   */\n  sidecarUrl?: string;\n};\n\nexport const INTEGRATION_NAME = 'Spotlight';\n\nconst _spotlightIntegration = ((options: Partial<SpotlightConnectionOptions> = {}) => {\n  const _options = {\n    sidecarUrl: options.sidecarUrl || 'http://localhost:8969/stream',\n  };\n\n  return {\n    name: INTEGRATION_NAME,\n    setup(client) {\n      try {\n        if (process.env.NODE_ENV && process.env.NODE_ENV !== 'development') {\n          debug.warn(\"[Spotlight] It seems you're not in dev mode. Do you really want to have Spotlight enabled?\");\n        }\n      } catch {\n        // ignore\n      }\n      connectToSpotlight(client, _options);\n    },\n  };\n}) satisfies IntegrationFn;\n\n/**\n * Use this integration to send errors and transactions to Spotlight.\n *\n * Learn more about spotlight at https://spotlightjs.com\n *\n * Important: This integration only works with Node 18 or newer.\n */\nexport const spotlightIntegration = defineIntegration(_spotlightIntegration);\n\nfunction connectToSpotlight(client: Client, options: Required<SpotlightConnectionOptions>): void {\n  const spotlightUrl = parseSidecarUrl(options.sidecarUrl);\n  if (!spotlightUrl) {\n    return;\n  }\n\n  let failedRequests = 0;\n\n  client.on('beforeEnvelope', (envelope: Envelope) => {\n    if (failedRequests > 3) {\n      debug.warn('[Spotlight] Disabled Sentry -> Spotlight integration due to too many failed requests');\n      return;\n    }\n\n    const serializedEnvelope = serializeEnvelope(envelope);\n    suppressTracing(() => {\n      const req = http.request(\n        {\n          method: 'POST',\n          path: spotlightUrl.pathname,\n          hostname: spotlightUrl.hostname,\n          port: spotlightUrl.port,\n          headers: {\n            'Content-Type': 'application/x-sentry-envelope',\n          },\n        },\n        res => {\n          if (res.statusCode && res.statusCode >= 200 && res.statusCode < 400) {\n            // Reset failed requests counter on success\n            failedRequests = 0;\n          }\n          res.on('data', () => {\n            // Drain socket\n          });\n\n          res.on('end', () => {\n            // Drain socket\n          });\n          res.setEncoding('utf8');\n        },\n      );\n\n      req.on('error', () => {\n        failedRequests++;\n        debug.warn('[Spotlight] Failed to send envelope to Spotlight Sidecar');\n      });\n      req.write(serializedEnvelope);\n      req.end();\n    });\n  });\n}\n\nfunction parseSidecarUrl(url: string): URL | undefined {\n  try {\n    return new URL(`${url}`);\n  } catch {\n    debug.warn(`[Spotlight] Invalid sidecar URL: ${url}`);\n    return undefined;\n  }\n}\n"],"names":[],"mappings":"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"}