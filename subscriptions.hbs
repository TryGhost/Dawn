{{!< ./default}} <main id="site-main" class="site-main site-signup outer">
    <div class="membership-container">
        {{!-- If member --}}
        {{!-- Choose plan --}}
        {{!-- Else --}}
        {{!-- Inputs --}}
        <form data-members-form>
            <div class="signup-form">
            {{#unless @member}}
                <div class="input-container">
                    <label class="name-input">
                        Name
                        <input id="name" data-members-name placeholder="Craig Mod" required="true" />
                    </label>
                    <label class="email-input">
                        Email
                        <input id="email" data-members-email type="email" required="true"
                            placeholder="craigmod@theteastand.org" />
                    </label>
                </div>
                <div id="error" class="error-container" data-members-error></div>
            {{else }}
                <h1>Choose a plan</h1>
            {{/unless}}
            </div>

            <section class="membership-plans">
                {{#get "tiers" include="id,name,description,monthly_price,benefits" limit="all" as |tiers|}}
                {{#foreach tiers as |tier|}}
                {{#if monthly_price}}
                {{!-- Paid tier --}}
                <div class="card" data-test-tier="paid">
                    <div class="card-header">
                        <h4 class="plan-name" style="color: {{@site.accent_color}}">{{name}}</h4>
                        <div class="price-container">
                            <span class="price-currency">$</span>
                            <span class="plan-amount title" data-testid="product-amount">{{price monthly_price}}</span>
                            <span class="billing-period">/month</span>
                        </div>
                    </div>
                    <div class="card-details">
                        <div class="plan-description" data-testid="product-description">
                            {{description}}</div>
                        <div class="benefit-list">
                            {{#foreach benefits as |benefit|}}
                            <div class="benefit-title">✓ {{benefit}}</div>
                            {{/foreach}}
                        </div>
                    </div>
                    <button type="submit" data-portal="signup/{{id}}/monthly" class="plan-button"
                        style="background-color: {{@site.accent_color}}">Choose</button>
                </div>
                {{else}}
                {{#unless @member}}
                {{!-- Free tier and not a member --}}
                <div class="card" data-test-tier="free">
                    <div class="card-header">
                        <h4 class="plan-name" style="color: {{@site.accent_color}}">{{name}}</h4>
                        <div class="price-container">
                            <span class="plan-amount title">Free</span>
                        </div>
                    </div>
                    <div class="card-details">
                        <div class="plan-description" data-testid="product-description">
                            {{description}}</div>
                        <div class="benefit-list">
                            {{#foreach benefits as |benefit|}}
                            <div class="benefit-title">✓ {{benefit}}</div>
                            {{/foreach}}
                        </div>
                    </div>
                    <button type="submit" class="plan-button"
                        style="background-color: {{@site.accent_color}}">
                    <a class="subscription-link" href="/signup-success">
                        Choose
                    </a>
                        </button>
                </div>
                {{/unless}}
                {{/if}}

                {{/foreach}}
                {{/get}}
                {{!-- Pay what you wish --}}
        <div class="card" data-test-tier="paid">
            <div class="card-header">
                <h4 class="plan-name" style="color: {{@site.accent_color}}">Pay what you wish</h4>
                <div>
                    <span class="price-currency">$</span>
                    <input id="subscriptionAmount" class="number-input title" type="number" placeholder="15" />
                    <span class="billing-period">/month</span>
                </div>
            </div>
            <div class="card-details">
                <div class="plan-description" data-testid="product-description">
                    Choose your own monthly contribution and receive perks! </div>
                <div class="benefit-list">
                    <div class="benefit-title">✓ Receive perks of closest tier </div>
                    <div class="benefit-title">$4-8/month makes you a Sipper </div>
                    <div class="benefit-title">$10+ makes you a Steeper! </div>
                </div>
            </div>
            <button id="pwyw-button" class="plan-button"
                style="background-color: {{@site.accent_color}}">Choose</button>
        </div>
        </section>
        </form>
        {{#if @member.paid}}
        {{!-- {{#foreach @member.subscriptions}} {{cancel_link}} {{/foreach}} --}}
        <div class="cancel-subscription">
            <span>To cancel your subscription, see your <a href="#/portal/account"  style="color: {{@site.accent_color}}">account details</a></span>
        </div>
        {{/if}}
    </div>
    </main>

    <script type="text/javascript">
        function addClickHandlers() {
            document.getElementById("pwyw-button").addEventListener("click", function (ev) {
                // remove error
                document.getElementById("error").innerHTML = ""
                var subscriptionAmount = document.getElementById("subscriptionAmount").value;
                var email = document.getElementById("email").value;
                // no email or no price : ask user to fill all
                if (!email || !subscriptionAmount) {
                    document.getElementById("error").innerHTML = "Please fill in all the fields";
                    return;
                }
                console.log('got here')
                // call our custom backend
                fetch("https://teastand-backend.vercel.app/api/get-stripe-session", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "*/*"
                    },
                    body: JSON.stringify({ email, amount: subscriptionAmount })
                }).then(function (result) {
                    return result.json()
                }).then(function (json) {
                    // post payment redirection 
                    document.location = json.url
                })
                console.log('got to the end')
            })
        }

        document.addEventListener("DOMContentLoaded", function () {
            addClickHandlers()
        });

    </script>